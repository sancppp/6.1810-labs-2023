# Lab5

COW写时复制
> “计算机中的所有问题都可以引入中间层解决”
问题描述：fork系统调用会复制父进程的所有用户空间内存给子进程，导致开销大。另外，fork出来的子进程通常会执行exec切换内存，所以复制的父进程内存马上会被丢弃。

解决方案：实现COW-fork()：
- fork时只给子进程一个页表，里面的PTE指向父进程的物理页。
- 同时,将父子进程的PTE-flag都设置为只读。如果一个进程想写这些只读权限的物理地址，则触发缺页中断。
- 触发缺页中断后，将需要访问的物理页复制一份。

需要考虑此时如何释放内存页：维护物理页的引用计数：
- 因为kfree&kalloc两个函数很多地方都在用，所以需要在这两个函数内部维护引用计数。
- 在uvmcopy函数中维护。
- usertrap函数


坑：
- 只有PTE_W置1的页才需要COW
- 在中断处理时，有可能是真的page fault。PTE_COW不是1就直接略过。